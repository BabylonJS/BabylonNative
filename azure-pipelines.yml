trigger:
- master

pr:
- master

jobs:
- job: macOS
  timeoutInMinutes: 5
  pool:
    vmImage: 'macOS-10.14'
    
  steps:
  - script: |
      git submodule update --init --recursive
    displayName: 'Checkout dependencies'
    
  - script: |
      cmake --version
    displayName: 'CMake version'
  - script: |
      sudo xcode-select --switch /Applications/Xcode_11.3.1.app/Contents/Developer
    displayName: 'Select XCode 11.3.1'
    
  - script: |
      mkdir buildmacOS
      cd buildmacOS
      cmake .. -GXcode
    displayName: 'Generate macOS solution'
      
  - task: Xcode@5
    inputs:
      xcWorkspacePath: 'buildmacOS/BabylonNative.xcodeproj'
      scheme: 'Playground'
      sdk: 'macosx'
      useXcpretty: false
    displayName: 'Build macOS'
  - script: |
      buildmacOS/Apps/Playground/Debug/Playground.app/Contents/MacOS/Playground
    displayName: 'Test MacOS'
    
- job: Ubuntu
  timeoutInMinutes: 5
  pool:
    vmImage: 'ubuntu-latest'

  variables:
    CC: clang-8
    CXX: clang++-8

  steps:
  - script: |
      git submodule update --init --recursive
    displayName: 'Checkout dependencies'
  - script: |
      sudo apt-get update
      sudo apt-get install libjavascriptcoregtk-4.0-dev libgl1-mesa-dev libcurl4-openssl-dev clang-8 libc++-8-dev libc++abi-8-dev lld-8 ninja-build
    displayName: 'Install packages'
  - script: |
      mkdir build
      cd build
      cmake .. -GNinja -DJSCORE_LIBRARY=/usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so
      ninja
    displayName: 'Build X11'
  - script: |
      export DISPLAY=:99
      Xvfb :99 -screen 0 1600x900x24 &
      sleep 3
      cd build/Apps/ValidationTests
      mkdir Errors
      mkdir Results
      ./ValidationTests
    displayName: 'Test on CI'
  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Rendered Pictures'
      pathtoPublish: 'build/Apps/ValidationTests/Results'
    displayName: 'Publish Tests Results'
  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Rendered Pictures with errors'
      pathtoPublish: 'build/Apps/ValidationTests/Errors'
    displayName: 'Publish Error Results'
