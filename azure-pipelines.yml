trigger:
- master

pr:
- master

jobs:
- job: androidV8
  timeoutInMinutes: 25
  pool:
    vmImage: 'macOS-10.14'
    
  steps:
  - script: |
      git submodule update --init --recursive
    displayName: 'Checkout dependencies'
  - script: |
      set -eu
      curl -Ls https://github.com/ninja-build/ninja/releases/download/v1.9.0/ninja-mac.zip -o ninja-mac.zip
      unzip ninja-mac.zip
      sudo cp -v ninja /usr/local/bin/
    displayName: 'Install Ninja'
  - script: |
      cd Apps/Playground/Android
      npm install
    displayName: 'Install JS engine NPMs'    
  - task: Gradle@2
    inputs:
        workingDirectory: 'Apps/Playground/Android'
        gradleWrapperFile: 'Apps/Playground/Android/gradlew'
        gradleOptions: '-Xmx1536m'
        options: '-PJSEngine=v8android'
        publishJUnitResults: false
        tasks: 'assembleDebug'
    displayName: 'Build androidV8'
# useful commands
# list already installed Android packages : $ANDROID_HOME/tools/bin/sdkmanager --list
# stop activity : adb shell am force-stop com.android.babylonnative.playground
# test activity is running : adb shell pidof com.android.babylonnative.playground
#$ANDROID_HOME/platform-tools/adb devices
# adb shell pm grant com.android.babylonnative.playground android.permission.CAMERA
  - bash: |
      echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-27;google_apis;x86'
    displayName: 'Install Android image'
  - script: |
      $ANDROID_HOME/emulator/emulator -list-avds
      echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd -n test_android_emulator -k 'system-images;android-27;google_apis;x86' --force
      $ANDROID_HOME/emulator/emulator -list-avds
    displayName: 'Create AVD'
  - script: |
      nohup $ANDROID_HOME/emulator/emulator -avd test_android_emulator -no-snapshot -skin 400x600 > /dev/null 2>&1 & $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'
    displayName: 'Start Android emulator'
  - script: |
      cd Apps/Playground/Android
      adb install -t -g app/build/outputs/apk/debug/app-debug.apk
      adb shell am start -n com.android.babylonnative.playground/com.android.babylonnative.playground.PlaygroundActivity
      sleep 15
      adb shell content insert --uri content://settings/system --bind name:s:accelerometer_rotation --bind value:i:0
      adb shell content insert --uri content://settings/system --bind name:s:user_rotation --bind value:i:1
      adb logcat -t 5000
      mkdir Captures
      adb exec-out screencap -p > Captures/screen.png
    displayName: 'Install and run APK'
  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Android Rendered Pictures'
      pathtoPublish: 'Apps/Playground/Android/Captures'
    displayName: 'Publish Tests Android Results'
