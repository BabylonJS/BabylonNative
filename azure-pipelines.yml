trigger:
- master

pr:
- master

jobs:
- job: win32_x64
  timeoutInMinutes: 30
  pool:
    vmImage: 'windows-latest'

  steps:
  - script: |
      git submodule update --init --recursive
    displayName: 'Checkout dependencies'

  - script: |
      mkdir buildWin32_x64
      cd buildWin32_x64
      cmake -G "Visual Studio 16 2019" -A x64 -DBGFX_CONFIG_MEMORY_TRACKING=ON -DBGFX_CONFIG_DEBUG=ON ..
    displayName: 'Generate Win32_x64 solution'

  - task: MSBuild@1
    inputs:
      solution: 'buildWin32_x64/BabylonNative.sln'
      maximumCpuCount: true
      configuration: 'RelWithDebInfo'
    displayName: 'Build WIN32_x64'

  - script: |
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe"
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe" /v DumpType /t REG_DWORD /d 2
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe" /v DumpCount /t REG_DWORD /d 1
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe" /v DumpFolder /t REG_SZ /d "$(Build.ArtifactStagingDirectory)/Dumps"
    displayName: 'Enable Crash Dumps'

  - script: |
      cd buildWin32_x64\Apps\ValidationTests
      mkdir Results
      mkdir Errors
      cd RelWithDebInfo
      ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests
    displayName: 'Validation Tests'

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Win32_x64 Rendered Pictures'
      pathtoPublish: 'buildWin32_x64/Apps/ValidationTests/Results'
    displayName: 'Publish Tests Win32_x64 Results'
    condition: succeeded()

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Win32_x64 Error Pictures'
      pathtoPublish: 'buildWin32_x64/Apps/ValidationTests/Errors'
    displayName: 'Publish Tests Win32_x64 Errors'
    condition: failed()

  - task: CopyFiles@2
    inputs:
      sourceFolder: 'buildWin32_x64/Apps/ValidationTests/RelWithDebInfo'
      contents: ValidationTests.*
      targetFolder: '$(Build.ArtifactStagingDirectory)/Dumps'
      cleanTargetFolder: false
    displayName: 'Stage test app exe/pdb for publishing'
    condition: failed()

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Win32_x64 Crash Dumps'
      pathtoPublish: '$(Build.ArtifactStagingDirectory)/Dumps'
    displayName: 'Publish Tests Win32_x64 Dumps'
    condition: failed()

- job: win32_x86
  timeoutInMinutes: 30 
  pool:
    vmImage: 'windows-latest'

  steps:
  - script: |
      git submodule update --init --recursive
    displayName: 'Checkout dependencies'

  - script: |
      mkdir buildWin32_x86
      cd buildWin32_x86
      cmake .. -G "Visual Studio 16 2019" -A Win32 -DBGFX_CONFIG_MEMORY_TRACKING=ON -DBGFX_CONFIG_DEBUG=ON
    displayName: 'Generate Win32_x86 solution'

  - task: MSBuild@1
    inputs:
      solution: 'buildWin32_x86/BabylonNative.sln'
      maximumCpuCount: true
      configuration: 'RelWithDebInfo'
    displayName: 'Build WIN32_x86'

  - script: |
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe"
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe" /v DumpType /t REG_DWORD /d 2
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe" /v DumpCount /t REG_DWORD /d 1
      reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps\ValidationTests.exe" /v DumpFolder /t REG_SZ /d "$(Build.ArtifactStagingDirectory)/Dumps"
    displayName: 'Enable Crash Dumps'

  - script: |
      cd buildWin32_x86\Apps\ValidationTests
      mkdir Results
      mkdir Errors
      cd RelWithDebInfo
      ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests && ValidationTests
    displayName: 'Validation Tests'

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Win32_x86 Rendered Pictures'
      pathtoPublish: 'buildWin32_x86/Apps/ValidationTests/Results'
    displayName: 'Publish Tests Win32_x86 Results'
    condition: succeeded()

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Win32_x86 Error Pictures'
      pathtoPublish: 'buildWin32_x86/Apps/ValidationTests/Errors'
    displayName: 'Publish Tests Win32_x86 Errors'
    condition: failed()

  - task: CopyFiles@2
    inputs:
      sourceFolder: 'buildWin32_x86/Apps/ValidationTests/RelWithDebInfo'
      contents: ValidationTests.*
      targetFolder: '$(Build.ArtifactStagingDirectory)/Dumps'
      cleanTargetFolder: false
    displayName: 'Stage test app exe/pdb for publishing'
    condition: failed()

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'Win32_x86 Crash Dumps'
      pathtoPublish: '$(Build.ArtifactStagingDirectory)/Dumps'
    displayName: 'Publish Tests Win32_x86 Dumps'
    condition: failed()

