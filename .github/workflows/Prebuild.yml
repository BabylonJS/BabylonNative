name: prebuild

on:
  push:
    branches:
      - 'master'

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [win32, x64, ARM64]
        config: [Debug, Release, RelWithDebInfo]
    steps:
      - name: Checkout
        uses: actions/checkout@master
        with:
          submodules: 'recursive'
      - name: Make Solution
        run: cmake -B build -A ${{ matrix.platform }} -D BGFX_CONFIG_DEBUG=ON -D BABYLON_NATIVE_BUILD_APPS=false -D CMAKE_UNITY_BUILD=true . 
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.3.1
      - name: Build
        run: msbuild build/BabylonNative.sln -p:Configuration="${{ matrix.config }}" -p:Platform=${{ matrix.platform }} 
      - name: Install
        run: cmake --build build --target INSTALL --config ${{ matrix.config }}
      - name: Upload Install Folder
        uses: actions/upload-artifact@v2
        with:
          name: 'Assembled-${{ matrix.config }}${{ matrix.platform }}'
          path: build/install

  build-scripts:
    runs-on: windows-latest
    steps:
      - name: Upload Package scripts
        uses: actions/upload-artifact@v2
        with:
          name: 'Assembled-Scripts'
          path: Install/FindBabylonNative.cmake

  package:
    needs: [build-windows, build-scripts]
    runs-on: windows-latest
    steps:
      - name: Download Debug x86 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-Debugwin32'
          path: Package/Windows/Debug/x86
      - name: Download Debug x64 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-Debugx64'
          path: Package/Windows/Debug/x64
      - name: Download Debug ARM64 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-DebugARM64'
          path: Package/Windows/Debug/ARM64
      - name: Download Release x86 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-Releasewin32'
          path: Package/Windows/Release/x86
      - name: Download Release x64 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-Releasex64'
          path: Package/Windows/Release/x64
      - name: Download Release ARM64 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-ReleaseARM64'
          path: Package/Windows/Release/ARM64
      - name: Download RelWithDebInfo x86 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-RelWithDebInfowin32'
          path: Package/Windows/RelWithDebInfo/x86
      - name: Download RelWithDebInfo x64 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-RelWithDebInfox64'
          path: Package/Windows/RelWithDebInfo/x64
      - name: Download RelWithDebInfo ARM64 
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-RelWithDebInfoARM64'
          path: Package/Windows/RelWithDebInfo/Arm64
      - name: Download Scripts
        uses: actions/download-artifact@v2
        with:
          name: 'Assembled-Scripts'
          path: Package
          
      - name: Upload Install Windows
        uses: actions/upload-artifact@v2
        with:
          name: 'Assembled-Windows'
          path: Package

      #- name: Create Release
      #  id: create_release
      #  uses: actions/create-release@v1
      #  env:
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
      #  with:
      #    tag_name: ${{ github.ref }}
      #    release_name: Release ${{ github.ref }}
      #    body: |
      #      Changes in this Release
      #      - First Change
      #      - Second Change
      #    draft: false
      #    prerelease: false